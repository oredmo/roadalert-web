<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RoadAlert Upload</title>
  <link rel="stylesheet" href="style.css">

  <!-- ✅ App Insights v3 SDK snippet (corrected and ready) -->
  <script type="text/javascript">
    var appInsights = window.appInsights || (function (config) {
      function s(e) {
        t[e] = function () {
          var i = arguments;
          t.queue.push(function () { t[e].apply(t, i); });
        };
      }
      var t = { config: config }, r = document, f = window, e = "script", o, u;
      t.queue = [];
      o = r.createElement(e);
      o.src = "https://az416426.vo.msecnd.net/scripts/b/ai.3.min.js";
      r.getElementsByTagName(e)[0].parentNode.appendChild(o);
      for (var i = [
        "trackEvent", "trackPageView", "trackException", "trackTrace", "trackMetric",
        "startTrackPage", "stopTrackPage", "startTrackEvent", "stopTrackEvent",
        "addTelemetryInitializer", "setAuthenticatedUserContext", "clearAuthenticatedUserContext"
      ]; i.length;) s(i.pop());
      return t;
    })({
      connectionString: "InstrumentationKey=4c317b61-5741-4965-a81a-415ce50726fd",
      enableAutoRouteTracking: true
    });

    window.appInsights = appInsights;
    appInsights.trackPageView();
  </script>
</head>

<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="explore.html">Explore</a>
    <a href="user.html?userID=1">My Uploads</a>
  </nav>

  <h2>RoadAlert Upload</h2>

  <form id="uploadForm">
    <label for="file">Choose File (image or video):</label>
    <input type="file" id="file" name="File" required>

    <label for="fileName">File Name:</label>
    <input type="text" id="fileName" name="FileName" required>

    <label for="userID">User ID:</label>
    <input type="text" id="userID" name="userID" required>

    <label for="userName">User Name:</label>
    <input type="text" id="userName" name="userName" required>

    <button type="submit">Upload</button>
  </form>

  <p id="response"></p>

  <script>
    const form = document.getElementById('uploadForm');
    const response = document.getElementById('response');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const endpoint = "https://prod-08.northcentralus.logic.azure.com:443/workflows/d324804e45064a91a2aea867f4ad9712/triggers/When_a_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_a_HTTP_request_is_received%2Frun&sv=1.0&sig=VnKo7U8gUkNfexwI9AknaxR_ie3OzvJUb9hwyGFmiUw";

      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        // ✅ Custom event tracking (correct method for SDK v3 snippet)
        appInsights.trackEvent({ 
          name: "UploadSuccess" 
        }, {
          fileName: form.fileName.value,
          userID: form.userID.value
        });

        response.textContent = "✅ Upload successful! Response ID: " + (data.id || "unknown");

      } catch (err) {
        appInsights.trackException({
          exception: new Error(err.message),
          properties: { action: "UploadFormSubmit" }
        });

        response.textContent = "❌ Error: " + err.message;
      }
    });
  </script>
</body>
</html>
