<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Details | RoadAlert</title>
  <link rel="stylesheet" href="style.css">

  <script type="text/javascript">
    (function (c, l, a, r, i, t, y) {
      c[a] = c[a] || function () {
        (c[a].q = c[a].q || []).push(arguments);
      };
      t = l.createElement(r); t.async = 1; t.src = "https://az416426.vo.msecnd.net/scripts/b/ai.3.min.js";
      y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
    })(window, document, "appInsights", "script");

    appInsights("config", {
      connectionString: "InstrumentationKey=4c317b61-5741-4965-a81a-415ce50726fd",
      enableAutoRouteTracking: true
    });

    appInsights("trackPageView");
  </script>
</head>

<body>

  <h1>User Uploads</h1>
  <ul id="uploadList">Loading user uploads...</ul>
  <a href="index.html">‚¨Ö Back to Upload Page</a>

  <script>
    const readUrl = "https://prod-12.northcentralus.logic.azure.com/...";
    const updateUrl = "https://prod-04.northcentralus.logic.azure.com/...";
    const deleteUrl = "https://prod-18.northcentralus.logic.azure.com/...";

    const userID = new URLSearchParams(window.location.search).get("userID");
    const uploadList = document.getElementById("uploadList");

    if (userID) getUploads(userID);
    else uploadList.textContent = "No user ID specified in URL.";

    async function getUploads(userID) {
      uploadList.innerHTML = `Loading uploads for user ${userID}...`;
      try {
        const res = await fetch(readUrl);
        const data = await res.json();

        appInsights("trackEvent", {
          name: "UserUploadsFetchSuccess",
          properties: { userID: userID, count: data.Documents?.length || 0 }
        });

        uploadList.innerHTML = "";

        const userDocs = (data.Documents || []).filter(d => d.userID === userID);
        if (userDocs.length === 0) {
          uploadList.innerHTML = `<li>No uploads found for user ID: ${userID}</li>`;
          return;
        }

        userDocs.forEach(doc => {
          const blob = doc.filePath?.split("/").pop();
          const blobUrl = `https://roadalertblobstorage.blob.core.windows.net/rablobimagecontainer/${blob}`;
          const li = document.createElement("li");
          li.innerHTML = `
            <strong>${doc.fileName}</strong> by <em>${doc.userName}</em><br>
            <img src="${blobUrl}" alt="${doc.fileName}" /><br><br>
            <button onclick="deleteUpload('${doc.id}', '${doc.filePath}')">üóëÔ∏è Delete</button>
            <button onclick="toggleEdit('${doc.id}')">‚úèÔ∏è Edit</button>
            <div id="edit-${doc.id}" style="display:none; margin-top:10px;">
              <input type="text" id="name-${doc.id}" value="${doc.fileName}" placeholder="New File Name"><br>
              <input type="text" id="user-${doc.id}" value="${doc.userName}" placeholder="New User Name"><br>
              <button onclick="submitEdit('${doc.id}', '${doc.filePath}', '${doc.fileLocator}')">Save</button>
            </div>
          `;
          uploadList.appendChild(li);
        });
      } catch (err) {
        appInsights("trackException", {
          exception: new Error(err.message),
          properties: { context: "UserUploadsFetch" }
        });
        uploadList.textContent = "Failed to load uploads: " + err.message;
      }
    }

    function toggleEdit(id) {
      document.getElementById(`edit-${id}`).style.display = "block";
    }

    async function deleteUpload(id, filePath) {
      try {
        const res = await fetch(deleteUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id, pk: id, filePath })
        });

        const msg = await res.text();
        appInsights("trackEvent", {
          name: res.ok ? "DeleteSuccess" : "DeleteFailure",
          properties: { id, status: res.status }
        });

        if (res.ok) {
          alert("Deleted!");
          location.reload();
        } else {
          alert("Delete failed. Check console.");
          console.error(msg);
        }
      } catch (err) {
        appInsights("trackException", {
          exception: new Error(err.message),
          properties: { context: "DeleteUpload" }
        });
      }
    }

    async function submitEdit(id, filePath, fileLocator) {
      const fileName = document.getElementById(`name-${id}`).value;
      const userName = document.getElementById(`user-${id}`).value;

      const payload = {
        report_id: id,
        fileName,
        userName,
        userID,
        filePath,
        fileLocator,
        pk: id
      };

      try {
        const res = await fetch(updateUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await res.text();
        appInsights("trackEvent", {
          name: res.ok ? "EditSuccess" : "EditFailure",
          properties: { fileName, userName, status: res.status }
        });

        if (res.ok) {
          alert("Edit successful!");
          location.reload();
        } else {
          alert("Edit failed.");
          console.error(result);
        }
      } catch (err) {
        appInsights("trackException", {
          exception: new Error(err.message),
          properties: { context: "SubmitEdit" }
        });
      }
    }
  </script>

</body>
</html>
