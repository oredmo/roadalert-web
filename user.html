<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Details | RoadAlert</title>
  <link rel="stylesheet" href="style.css">

  <script type="text/javascript">
    var appInsights = window.appInsights || function (config) {
      function r(config) { t[config] = function () { var i = arguments; t.queue.push(function () { t[config].apply(t, i) }) } }
      var t = { config: config }, u = document, e = window, o = "script", s = u.createElement(o), i, f;
      s.src = config.url || "https://az416426.vo.msecnd.net/scripts/a/ai.0.js";
      u.getElementsByTagName(o)[0].parentNode.appendChild(s);
      t.queue = [];
      for (i = ["Event", "Exception", "Metric", "PageView", "Trace", "Dependency"]; i.length;) r("track" + i.pop());
      r("setAuthenticatedUserContext"); r("clearAuthenticatedUserContext");
      config.disableExceptionTracking || (i = "onerror", r("_" + i), f = e[i], e[i] = function (config, r, u, e, o) {
        var s = f && f(config, r, u, e, o);
        s !== !0 && t["_" + i](config, r, u, e, o);
        return s;
      });
      return t;
    }({
      instrumentationKey: "4c317b61-5741-4965-a81a-415ce50726fd" 
    });
    window.appInsights = appInsights;
    appInsights.trackPageView();
  </script>
</head>

<body>
  <h1>User Uploads</h1>
  <ul id="uploadList">Loading user uploads...</ul>
  <a href="index.html">‚¨Ö Back to Upload Page</a>

  <script>
    const readUrl = "https://prod-12.northcentralus.logic.azure.com/...";
    const updateUrl = "https://prod-04.northcentralus.logic.azure.com/...";
    const deleteUrl = "https://prod-18.northcentralus.logic.azure.com/...";

    const userID = new URLSearchParams(window.location.search).get("userID");
    const uploadList = document.getElementById("uploadList");

    if (userID) getUploads(userID);
    else uploadList.textContent = "No user ID specified in URL.";

    async function getUploads(userID) {
      uploadList.innerHTML = `Loading uploads for user ${userID}...`;
      try {
        const res = await fetch(readUrl);
        const data = await res.json();
        uploadList.innerHTML = "";

        const userDocs = (data.Documents || []).filter(d => d.userID === userID);
        if (userDocs.length === 0) {
          uploadList.innerHTML = `<li>No uploads found for user ID: ${userID}</li>`;
          return;
        }

        userDocs.forEach(doc => {
          const blob = doc.filePath?.split("/").pop();
          const blobUrl = `https://roadalertblobstorage.blob.core.windows.net/rablobimagecontainer/${blob}`;
          const li = document.createElement("li");
          li.innerHTML = `
            <strong>${doc.fileName}</strong> by <em>${doc.userName}</em> (User ID: ${userID})<br>
            <img src="${blobUrl}" alt="${doc.fileName}" /><br><br>
            <button onclick="deleteUpload('${doc.id}', '${doc.filePath}')">üóëÔ∏è Delete</button>
            <button onclick="toggleEdit('${doc.id}')">Edit</button>
            <div id="edit-${doc.id}" style="display:none; margin-top:10px;">
              <input type="text" id="name-${doc.id}" value="${doc.fileName}" placeholder="New File Name"><br>
              <input type="text" id="user-${doc.id}" value="${doc.userName}" placeholder="New User Name"><br>
              <button onclick="submitEdit('${doc.id}', '${doc.filePath}', '${doc.fileLocator}')">Save</button>
            </div>
          `;
          uploadList.appendChild(li);
        });

      } catch (err) {
        appInsights.trackException({ exception: new Error(err.message), properties: { action: "getUploads" } });
        uploadList.textContent = "Failed to load uploads: " + err.message;
      }
    }

    function toggleEdit(id) {
      document.getElementById(`edit-${id}`).style.display = "block";
    }

    async function deleteUpload(id, filePath) {
      console.log("Deleting ID:", id);
      const pk = id;
      const payload = { id, pk, filePath };

      appInsights.trackEvent({ name: "DeleteAttempt", properties: payload });

      try {
        const res = await fetch(deleteUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const msg = await res.text();
        console.log("Delete response:", msg);

        if (res.ok) {
          appInsights.trackEvent({ name: "DeleteSuccess", properties: { id } });
          alert("Deleted!");
          location.reload();
        } else {
          appInsights.trackException({
            exception: new Error("Delete failed"),
            properties: { response: msg, id }
          });
          alert("Delete failed. Check console.");
        }
      } catch (err) {
        appInsights.trackException({ exception: err, properties: { action: "deleteUpload", id } });
        console.error("Delete error:", err);
      }
    }

    async function submitEdit(id, filePath, fileLocator) {
      const fileName = document.getElementById(`name-${id}`).value;
      const userName = document.getElementById(`user-${id}`).value;

      const payload = {
        report_id: id,
        fileName,
        userName,
        userID,
        filePath,
        fileLocator,
        pk: id
      };

      appInsights.trackEvent({ name: "EditAttempt", properties: payload });

      try {
        const res = await fetch(updateUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await res.text();
        console.log("Edit response:", result);

        if (res.ok) {
          appInsights.trackEvent({ name: "EditSuccess", properties: { id } });
          alert("Edit successful!");
          location.reload();
        } else {
          appInsights.trackException({
            exception: new Error("Edit failed"),
            properties: { response: result, id }
          });
          alert("Edit failed. Check console.");
        }
      } catch (err) {
        appInsights.trackException({ exception: err, properties: { action: "submitEdit", id } });
        console.error("Edit error:", err);
      }
    }
  </script>

</body>
</html>
